/**
 * @fileName : InfiniteListPage.ets
 * @author : @cxy
 * @date : 2025/8/31
 * @description : æ— é™æ»šåŠ¨ç¤ºä¾‹
 */

import { RefreshList, RefreshFooterData, RefreshFooterState } from '@cxy/refreshlist'
import { ItemModel } from '../../models/ItemModel'
import { InfiniteViewModel } from './InfiniteViewModel'

@Builder
function routerBuilder() {
  InfiniteListPage()
}

@Component
struct InfiniteListPage {
  @State title: string = ''
  @State viewModel: InfiniteViewModel = new InfiniteViewModel()
  @State isAutoLoading: boolean = false

  build() {
    NavDestination() {
      Column() {
        // æ§åˆ¶é¢æ¿
        this.controlPanel()

        // æ— é™æ»šåŠ¨åˆ—è¡¨
        RefreshList({
          dataSource: this.viewModel.dataSource,
          controller: this.viewModel.controller,
          onRefresh: () => this.viewModel.refresh(),
          onLoadMore: () => this.viewModel.loadMore(),
          itemLayout: (item: Object, index: number) => this.infiniteItemLayout(item as ItemModel),

          // è‡ªå®šä¹‰åŠ è½½æ›´å¤šæ ·å¼
          refreshFooterLayout: () => this.customFooterLayout(),

          // æ»šåŠ¨å›è°ƒ
          onDidScroll: (scrollOffset: number, scrollState: ScrollState) => {
            this.handleScroll(scrollOffset, scrollState)
          },

          onReachEnd: () => {
            console.log('åˆ°è¾¾åº•éƒ¨')
          },

          keyGenerator: (item: ItemModel) => item.id
        })
          .layoutWeight(1)
      }
      .width('100%')
      .height('100%')
    }
    .title(this.title)
    .onReady((ctx) => {
      this.title = ctx.pathInfo.param as string
      this.viewModel.refresh()
    })
  }

  @Builder
  controlPanel(): void {
    Column() {
      Row() {
        Text('æ— é™æ»šåŠ¨æ¼”ç¤º')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)

        Button(this.isAutoLoading ? 'åœæ­¢è‡ªåŠ¨åŠ è½½' : 'å¼€å¯è‡ªåŠ¨åŠ è½½')
          .fontSize(12)
          .backgroundColor(this.isAutoLoading ? '#ff4444' : '#007AFF')
          .onClick(() => {
            this.isAutoLoading = !this.isAutoLoading
            this.viewModel.setAutoLoading(this.isAutoLoading)
          })
      }
      .width('100%')
      .padding(15)

      Row() {
        Text(`å·²åŠ è½½: ${this.viewModel.dataSource.totalCount()} é¡¹`)
          .fontSize(14)
          .fontColor('#666')

        Blank()

        Text(`é¡µæ•°: ${this.viewModel.getCurrentPage()}`)
          .fontSize(14)
          .fontColor('#666')

        Blank()

        Text(`çŠ¶æ€: ${this.viewModel.getLoadingStatus()}`)
          .fontSize(14)
          .fontColor(this.viewModel.getLoadingStatus() === 'åŠ è½½ä¸­' ? '#ff6b6b' : '#666')
      }
      .width('100%')
      .padding({ left: 15, right: 15, bottom: 15 })
    }
    .backgroundColor('#f8f8f8')
  }

  @Builder
  infiniteItemLayout(item: ItemModel): void {
    ListItem() {
      Row() {
        // åºå·
        Text(`${item.index || 0}`)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#007AFF')
          .width(50)
          .textAlign(TextAlign.Center)

        // å†…å®¹
        Column() {
          Text(item.title)
            .fontSize(16)
            .fontColor('#333')
            .fontWeight(FontWeight.Medium)

          Text(item.description || 'è¿™æ˜¯ä¸€ä¸ªæ— é™æ»šåŠ¨çš„åˆ—è¡¨é¡¹')
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 4 })

          Row() {
            Text(`ID: ${item.id}`)
              .fontSize(12)
              .fontColor('#999')

            Blank()

            Text(String(item.timestamp))
              .fontSize(12)
              .fontColor('#999')
          }
          .width('100%')
          .margin({ top: 8 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        // æ“ä½œæŒ‰é’®
        Column() {
          Button('è¯¦æƒ…')
            .fontSize(12)
            .backgroundColor('#f0f0f0')
            .fontColor('#333')
            .onClick(() => {
              console.log(`æŸ¥çœ‹è¯¦æƒ…: ${item.title}`)
            })
        }
      }
      .width('100%')
      .padding(15)
      .alignItems(VerticalAlign.Center)
    }
    .backgroundColor(Color.White)
    .margin({ bottom: 1 })
  }

  @Builder
  customFooterLayout(): void {
    Column() {
      if (this.viewModel.hasMore()) {
        Row() {
          LoadingProgress()
            .width(20)
            .height(20)
            .color('#ff6b6b')

          Text(this.isAutoLoading ? 'è‡ªåŠ¨åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤šæ•°æ®...')
            .fontSize(14)
            .fontColor('#666')
            .margin({ left: 8 })
        }
        .justifyContent(FlexAlign.Center)
      } else {
        Column() {
          Text('ğŸ‰ å·²åŠ è½½å…¨éƒ¨æ•°æ®')
            .fontSize(14)
            .fontColor('#999')

          Text(`å…± ${this.viewModel.dataSource.totalCount()} æ¡è®°å½•`)
            .fontSize(12)
            .fontColor('#ccc')
            .margin({ top: 4 })
        }
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height(60)
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#f8f8f8')
  }

  private handleScroll(scrollOffset: number, scrollState: ScrollState): void {
    // å¤„ç†æ»šåŠ¨äº‹ä»¶ï¼Œå¯ä»¥ç”¨äºå®ç°æ›´å¤æ‚çš„æ— é™æ»šåŠ¨é€»è¾‘
    if (this.isAutoLoading && scrollState === ScrollState.Scroll) {
      // è‡ªåŠ¨åŠ è½½æ¨¡å¼ä¸‹çš„å¤„ç†é€»è¾‘
    }
  }
}