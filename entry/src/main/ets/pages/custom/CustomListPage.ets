/**
 * @fileName : CustomListPage.ets
 * @author : @cxy
 * @date : 2025/8/31
 * @description : è‡ªå®šä¹‰ä½¿ç”¨ç¤ºä¾‹ - å±•ç¤ºå®Œå…¨è‡ªå®šä¹‰çš„åˆ—è¡¨å®ç°
 */

import {
  RefreshFooterData, RefreshFooterState, RefreshHeaderData, RefreshList
} from '@cxy/refreshlist'
import { ItemModel } from '../../models/ItemModel'
import { CustomListModel } from './CustomListModel'

@Builder
function routerBuilder() {
  CustomListPage()
}

@Component
struct CustomListPage {
  @State title: string = ''
  @State viewModel: CustomListModel = new CustomListModel()
  @State refreshHeaderData: RefreshHeaderData = new RefreshHeaderData()
  @State refreshFooterData: RefreshFooterData = new RefreshFooterData()

  build() {
    NavDestination() {
      RefreshList({
        dataSource: this.viewModel.dataSource,
        controller: this.viewModel.controller,
        onRefresh: () => this.viewModel.refresh(),
        onLoadMore: () => this.viewModel.loadMore(),

        // è‡ªå®šä¹‰çš„åˆ·æ–°å’ŒåŠ è½½ç»„ä»¶
        refreshHeaderLayout: () => this.refreshHeaderLayout(),
        refreshFooterLayout: () => this.refreshFooterLayout(),

        // è‡ªå®šä¹‰åˆ—è¡¨å†…å®¹å¸ƒå±€
        customLayout: () => this.customLayout(),

        // è‡ªå®šä¹‰åŠ è½½ä¸­å¸ƒå±€
        loadingLayout: () => this.loadingBuilder(),

        // è‡ªå®šä¹‰ç©ºé¡µé¢å¸ƒå±€
        emptyLayout: () => this.emptyBuilder(),

        // è‡ªå®šä¹‰çš„åˆ·æ–°å’ŒåŠ è½½æ•°æ®
        refreshHeaderData: this.refreshHeaderData,
        refreshFooterData: this.refreshFooterData,

        // æ ·å¼é…ç½®
        divider: { strokeWidth: 0, color: 'transparent' },
      })
        .backgroundColor('#f0f2f5')
    }
    .menus(this.menusBuilder)
    .title(this.title)
    .onReady((ctx) => {
      this.title = ctx.pathInfo.param as string
      this.viewModel.refresh()
    })
  }

  @Builder
  menusBuilder(): void {
    Row() {
      Text('æ¸…ç©º')
        .fontColor('#ff4444')
        .fontSize(16)
        .padding({ left: 16, right: 16 })
        .onClick(() => {
          this.viewModel.dataSource.deleteAll()
        })
    }
    .height('100%')
  }

  // è‡ªå®šä¹‰åˆ·æ–°å¤´éƒ¨åŠ¨ç”»
  @Builder
  refreshHeaderLayout(): void {
    Column() {
      Image($r('app.media.custom_header'))
        .width(34)
    }
    .padding(10)
  }

  // è‡ªå®šä¹‰åˆ·æ–°åº•éƒ¨åŠ¨ç”»
  @Builder
  refreshFooterLayout(): void {
    Column() {
      // æ ¹æ®ä¸åŒçŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹
      if (this.refreshFooterData.state === RefreshFooterState.Loading) {
        // åŠ è½½ä¸­çŠ¶æ€
        Row() {
          LoadingProgress()
            .width(20)
            .height(20)
            .color('#667eea')

          Text('åŠ è½½æ›´å¤šå†…å®¹...')
            .fontSize(12)
            .fontColor('#999')
            .margin({ left: 6 })
        }
        .justifyContent(FlexAlign.Center)

      } else if (this.refreshFooterData.state === RefreshFooterState.NoMore) {
        // æ²¡æœ‰æ›´å¤šæ•°æ®çŠ¶æ€
        Row() {
          Divider()
            .width(60)
            .height(1)
            .color('#ddd')

          Text('æ²¡æœ‰æ›´å¤šæ•°æ®äº†')
            .fontSize(12)
            .fontColor('#999')
            .margin({ left: 12, right: 12 })

          Divider()
            .width(60)
            .height(1)
            .color('#ddd')
        }
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)
      } else {
        // é»˜è®¤çŠ¶æ€æˆ–å…¶ä»–çŠ¶æ€
        Row() {
          Text('ä¸Šæ‹‰åŠ è½½æ›´å¤š')
            .fontSize(12)
            .fontColor('#999')
        }
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height(50)
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#fff')
    .visibility(this.refreshFooterData.isShow ? Visibility.Visible : Visibility.None)
  }

  // è‡ªå®šä¹‰åˆ—è¡¨å†…å®¹å¸ƒå±€
  @Builder
  customLayout(): void {
    LazyForEach(this.viewModel.dataSource, (item: ItemModel, index: number) => {
      ListItem() {
        this.customItemLayout(item, index)
      }
    }, (item: ItemModel) => item.id)
  }

  // è‡ªå®šä¹‰åŠ è½½çŠ¶æ€å¸ƒå±€
  @Builder
  loadingBuilder(): void {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#667eea')

      Text('æ­£åœ¨åŠ è½½æ•°æ®...')
        .fontSize(14)
        .fontColor('#666')
        .margin({ top: 16 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  // è‡ªå®šä¹‰ç©ºçŠ¶æ€å¸ƒå±€
  @Builder
  emptyBuilder(): void {
    Column() {
      // ç©ºçŠ¶æ€å›¾æ ‡
      Text('ğŸ“­')
        .fontSize(48)
        .margin({ bottom: 16 })

      Text('æš‚æ— æ•°æ®')
        .fontSize(18)
        .fontColor('#333')
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 8 })

      Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ·æ–°æ•°æ®')
        .fontSize(14)
        .fontColor('#999')
        .margin({ bottom: 24 })

      // åˆ·æ–°æŒ‰é’®
      Button('åˆ·æ–°æ•°æ®')
        .fontSize(14)
        .backgroundColor('#667eea')
        .borderRadius(20)
        .padding({
          left: 24,
          right: 24,
          top: 8,
          bottom: 8
        })
        .onClick(() => {
          this.viewModel.refresh()
        })
    }
    .width('100%')
    .height(300)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  customItemLayout(item: ItemModel, index: number): void {
    Column() {
      Row() {
        // åºå·æ ‡è¯†
        Column() {
          Text(`${index + 1}`)
            .fontSize(14)
            .fontColor('#fff')
            .fontWeight(FontWeight.Bold)
        }
        .width(32)
        .height(32)
        .borderRadius(16)
        .backgroundColor(item.avatarColor || '#667eea')
        .justifyContent(FlexAlign.Center)

        // å†…å®¹åŒºåŸŸ
        Column() {
          Text(item.title)
            .fontSize(16)
            .fontColor('#333')
            .fontWeight(FontWeight.Medium)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          if (item.description) {
            Text(item.description)
              .fontSize(14)
              .fontColor('#666')
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .margin({ top: 4 })
          }

          // æ ‡ç­¾å’Œæ—¶é—´
          Row() {
            if (item.category) {
              Text(item.category)
                .fontSize(10)
                .fontColor('#667eea')
                .backgroundColor('#f0f2ff')
                .padding({
                  left: 6,
                  right: 6,
                  top: 2,
                  bottom: 2
                })
                .borderRadius(4)
            }

            Blank()

            Text(item.time || 'åˆšåˆš')
              .fontSize(12)
              .fontColor('#999')
          }
          .width('100%')
          .margin({ top: 8 })
        }
        .layoutWeight(1)
        .margin({ left: 12 })
        .alignItems(HorizontalAlign.Start)

        // æ“ä½œæŒ‰é’®
        Column() {
          Image($r('sys.media.ohos_ic_public_more'))
            .width(20)
            .height(20)
            .fillColor('#ccc')
        }
        .onClick(() => {
          console.log(`æ“ä½œé¡¹ç›®: ${item.title}`)
        })
      }
      .width('100%')
      .padding(16)

      // è‡ªå®šä¹‰åˆ†éš”çº¿
      if (index < this.viewModel.dataSource.totalCount() - 1) {
        Divider()
          .strokeWidth(1)
          .color('#f0f0f0')
          .margin({ left: 60, right: 16 })
      }
    }
    .width('100%')
    .backgroundColor('#fff')
    .borderRadius(index === 0 ? { topLeft: 12, topRight: 12 } : 0)
    .onClick(() => {
      console.log(`ç‚¹å‡»è‡ªå®šä¹‰é¡¹ç›®: ${item.title}`)
    })
  }
}