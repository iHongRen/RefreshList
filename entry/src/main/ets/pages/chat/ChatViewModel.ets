/**
 * @fileName : ChatViewModel.ets
 * @author : @cxy
 * @date : 2025/8/31
 * @description : 聊天列表数据管理
 */

import { RefreshDataSource, RefreshController } from '@cxy/refreshlist'
import { ItemModel } from '../../models/ItemModel'

export class ChatViewModel {
  dataSource: RefreshDataSource = new RefreshDataSource()
  controller: RefreshController = new RefreshController()
  private currentPage: number = 1
  private pageSize: number = 20

  refresh(): void {
    this.requestPage(1)
  }

  loadMore(): void {
    this.requestPage(this.currentPage + 1)
  }

  requestPage(page: number) {
    // 模拟网络请求延迟
    setTimeout(() => {
      this.currentPage = page
      const data = this.generateData(this.pageSize)
      if (page === 1) {
        this.dataSource.deleteAll()
      }
      this.dataSource.pushDataArray(data)

      // 模拟最多5页数据
      const hasMore = page < 5
      this.controller.setHasmore(hasMore)
      this.controller.finishRefresh()
    }, 800)
  }

  private generateData(count: number): ItemModel[] {
    const names = [
      '张三', '李四', '王五', '赵六', '钱七', '孙八', '周九', '吴十',
      '郑十一', '王十二', '冯十三', '陈十四', '褚十五', '卫十六',
      '蒋十七', '沈十八', '韩十九', '杨二十'
    ]

    const lastMessages = [
      '你好，最近怎么样？', '今天天气不错呢', '晚上一起吃饭吧',
      '工作顺利吗？', '周末有什么安排？', '这个项目进展如何？',
      '谢谢你的帮助', '明天见面聊', '发个位置给我',
      '收到，马上过去', '好的，没问题', '辛苦了',
      '[图片]', '[语音]', '[视频通话]',
      '哈哈哈', '👍', '🎉'
    ]

    const messageTypes = ['text', 'image', 'voice', 'video']

    const timeFormats = [
      '刚刚', '1分钟前', '5分钟前', '10分钟前', '30分钟前',
      '1小时前', '2小时前', '昨天', '前天', '周一', '周二'
    ]

    const result: ItemModel[] = []
    for (let index = 0; index < count; index++) {
      const globalIndex = (this.currentPage - 1) * this.pageSize + index
      const isOnline = Math.random() > 0.3 // 70%在线概率
      const hasUnread = Math.random() > 0.6 // 40%有未读消息
      const unreadCount = hasUnread ? Math.floor(Math.random() * 20) + 1 : 0

      const item = new ItemModel(`chat_${globalIndex}`, names[globalIndex % names.length])
      item.name = names[globalIndex % names.length]
      item.lastMessage = lastMessages[globalIndex % lastMessages.length]
      item.messageType = messageTypes[Math.floor(Math.random() * messageTypes.length)]
      item.time = timeFormats[Math.floor(Math.random() * timeFormats.length)]
      item.isOnline = isOnline
      item.unreadCount = unreadCount
      item.avatar = `https://i.pravatar.cc/100?img=${(globalIndex % 50) + 1}`
      item.isPinned = globalIndex < 3 // 前3个置顶

      result.push(item)
    }
    return result
  }
}