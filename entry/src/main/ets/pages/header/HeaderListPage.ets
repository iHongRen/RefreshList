/**
 * @fileName : HeaderListPage.ets
 * @author : @cxy
 * @date : 2025/8/31
 * @description : å¸¦å¤´éƒ¨è§†å›¾çš„åˆ—è¡¨ç¤ºä¾‹
 */

import { RefreshList } from '@cxy/refreshlist'
import { RefreshLoadingView } from '@cxy/refreshlist/src/main/ets/refreshlist/RefreshLoadingView'
import { ItemModel } from '../../models/ItemModel'
import { HeaderViewModel } from './HeaderViewModel'

@Builder
function routerBuilder() {
  HeaderListPage()
}

interface StatItem {
  title: string,
  count: string
}

@Component
struct HeaderListPage {
  @State title: string = ''
  @State viewModel: HeaderViewModel = new HeaderViewModel()

  build() {
    NavDestination() {
      RefreshList({
        dataSource: this.viewModel.dataSource,
        controller: this.viewModel.controller,
        onRefresh: () => this.viewModel.refresh(),
        onLoadMore: () => this.viewModel.loadMore(),
        // è‡ªå®šä¹‰å¤´éƒ¨å¸ƒå±€
        headerLayout: () => this.headerLayout(),
        loadingLayout: () => this.loadingLayout(),
        itemLayout: (item: Object, index: number) => this.itemLayout(item as ItemModel),
        keyGenerator: (item: ItemModel) => item.id
      })
        .backgroundColor('#f8f9fa')
    }
    .title(this.title)
    .onReady((ctx) => {
      this.title = ctx.pathInfo.param as string
      this.viewModel.refresh()
    })
  }

  @Builder
  loadingLayout(): void {
    RefreshLoadingView().height(200)
  }

  @Builder
  headerLayout(): void {
    Column() {
      // é¡¶éƒ¨æ¨ªå¹…
      Stack() {
        // èƒŒæ™¯æ¸å˜
        Column()
          .width('100%')
          .height('100%')
          .linearGradient({
            direction: GradientDirection.Bottom,
            colors: [['#667eea', 0.0], ['#764ba2', 1.0]]
          })

        // å†…å®¹åŒºåŸŸ
        Column() {
          // æ ‡é¢˜åŒºåŸŸ
          Text('RefreshList ç»„ä»¶')
            .fontSize(24)
            .fontColor('#fff')
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 8 })

          Text('ç®€å•æ˜“ç”¨çš„ä¸‹æ‹‰åˆ·æ–°å’Œä¸Šæ‹‰åŠ è½½ç»„ä»¶')
            .fontSize(14)
            .fontColor('#ffffff80')
            .margin({ bottom: 20 })

          // ç»Ÿè®¡ä¿¡æ¯
          Row() {
            this.statItem({ title: 'æ€»æ•°æ®', count: `${this.viewModel.getTotalCount()}` })
            this.statItem({ title: 'å·²åŠ è½½', count: `${this.viewModel.totalCount}` })
            this.statItem({ title: 'é¡µæ•°', count: `${this.viewModel.currentPage}` })
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceAround)
        }
        .padding(20)
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      }
      .width('100%')
      .height(180)

      // åŠŸèƒ½å¡ç‰‡åŒºåŸŸ
      Row() {
        this.featureCard('ðŸ”„', 'ä¸‹æ‹‰åˆ·æ–°', 'æ”¯æŒè‡ªå®šä¹‰åˆ·æ–°åŠ¨ç”»')
        this.featureCard('ðŸš€', 'ä¸Šæ‹‰åŠ è½½', 'åŠ è½½æ›´å¤šæ•°æ®')
        this.featureCard('âš’ï¸', 'æ˜“ç”¨', 'é›†æˆLoadingå’Œç©ºé¡µé¢')
      }
      .width('100%')
      .padding({
        left: 16,
        right: 16,
        top: 16,
        bottom: 16
      })
      .justifyContent(FlexAlign.SpaceBetween)

      // åˆ†éš”çº¿
      Divider()
        .color('#eee')
        .strokeWidth(1)
        .margin({ left: 16, right: 16 })
    }
    .backgroundColor('#fff')
  }

  @Builder
  statItem(item: StatItem): void {
    Column() {
      Text(item.title)
        .fontSize(18)
        .fontColor('#fff')
        .fontWeight(FontWeight.Bold)

      Text(item.count)
        .fontSize(14)
        .fontColor('#ffffff80')
        .margin({ top: 4 })
    }
  }

  @Builder
  featureCard(icon: string, title: string, desc: string): void {
    Column() {
      Text(icon)
        .fontSize(24)
        .margin({ bottom: 8 })

      Text(title)
        .fontSize(14)
        .fontColor('#333')
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 4 })

      Text(desc)
        .fontSize(12)
        .fontColor('#666')
        .textAlign(TextAlign.Center)
        .maxLines(2)
    }
    .width('30%')
    .padding(12)
    .backgroundColor('#fff')
    .borderRadius(8)
    .shadow({
      radius: 4,
      color: '#1a000000',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  itemLayout(item: ItemModel): void {
    ListItem() {
      Column() {
        Row() {
          // å·¦ä¾§å›¾æ ‡
          Column() {
            Text(item.initial || 'ðŸ“„')
              .fontSize(16)
              .fontColor('#fff')
          }
          .width(40)
          .height(40)
          .borderRadius(20)
          .backgroundColor(item.avatarColor || '#4CAF50')
          .justifyContent(FlexAlign.Center)

          // å†…å®¹åŒºåŸŸ
          Column() {
            Text(item.title)
              .fontSize(16)
              .fontColor('#333')
              .fontWeight(FontWeight.Medium)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            if (item.description) {
              Text(item.description)
                .fontSize(14)
                .fontColor('#666')
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .margin({ top: 4 })
            }

            // åº•éƒ¨ä¿¡æ¯
            Row() {
              Text(item.time || 'åˆšåˆš')
                .fontSize(12)
                .fontColor('#999')

              if (item.category) {
                Text(item.category)
                  .fontSize(10)
                  .fontColor('#2196F3')
                  .backgroundColor('#e3f2fd')
                  .padding({
                    left: 6,
                    right: 6,
                    top: 2,
                    bottom: 2
                  })
                  .borderRadius(4)
                  .margin({ left: 8 })
              }
            }
            .width('100%')
            .margin({ top: 8 })
          }
          .layoutWeight(1)
          .margin({ left: 12 })
          .alignItems(HorizontalAlign.Start)

          // å³ä¾§ç®­å¤´
          Image($r('sys.media.ohos_ic_public_arrow_right'))
            .width(16)
            .height(16)
            .fillColor('#ccc')
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#fff')

        Divider().strokeWidth(0.5).color('#eee')
      }
    }
    .onClick(() => {
      console.log(`ç‚¹å‡»é¡¹ç›®: ${item.title}`)
    })
  }
}